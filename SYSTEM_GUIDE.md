# РУКОВОДСТВО ПО СИСТЕМЕ КОНТРОЛЯ ПОДРЯДЧИКОВ

## ОГЛАВЛЕНИЕ
1. [Общая архитектура](#общая-архитектура)
2. [Роли пользователей](#роли-пользователей)
3. [Проекты](#проекты)
4. [Объекты строительства](#объекты-строительства)
5. [Справочник работ (Work Templates)](#справочник-работ-work-templates)
6. [Работы на объектах](#работы-на-объектах)
7. [Жизненный цикл работ](#жизненный-цикл-работ)
8. [Права доступа](#права-доступа)
9. [Связи между сущностями](#связи-между-сущностями)

---

## ОБЩАЯ АРХИТЕКТУРА

Система представляет собой платформу для управления строительными проектами, объектами и работами на них. Основная концепция:

```
ПРОЕКТ (Project)
  └── ОБЪЕКТ СТРОИТЕЛЬСТВА (Object)
       └── РАБОТА (Work)
            └── Назначена ПОДРЯДЧИКУ (Contractor)
```

---

## РОЛИ ПОЛЬЗОВАТЕЛЕЙ

В системе существует 3 основные роли:

### 1. **client** (Заказчик)
- Создаёт проекты и объекты
- Назначает работы подрядчикам
- Видит все работы на своих объектах
- Принимает или отклоняет выполненные работы
- Управляет списком своих подрядчиков

### 2. **contractor** (Подрядчик)
- Видит только работы, назначенные ему
- Может менять статус своих работ
- Добавляет фото и материалы к работам
- Отчитывается о выполнении

### 3. **admin** (Администратор)
- Полный доступ ко всем данным
- Может выполнять действия за любую роль
- Управляет пользователями и организациями

---

## ПРОЕКТЫ

### Что такое проект?
Проект — это верхний уровень иерархии. Это контейнер для группы связанных объектов строительства.

**Примеры проектов:**
- "ЖК Солнечный" (внутри несколько корпусов-объектов)
- "Торговый центр Мега" (внутри разные секции)
- "Реконструкция школы №15"

### Структура данных проекта:
```
projects:
  - id (уникальный идентификатор)
  - title (название проекта)
  - description (описание)
  - client_id (ID заказчика-владельца)
  - status (active/completed)
  - created_at, updated_at
```

### Логика работы:
1. **Создание:** Только Заказчик (client) может создать проект
2. **Доступ:** Заказчик видит только свои проекты, Админ видит все
3. **Связь:** Проект содержит несколько объектов

---

## ОБЪЕКТЫ СТРОИТЕЛЬСТВА

### Что такое объект?
Объект — это физическое место, где ведутся работы (здание, корпус, участок дороги и т.д.).

**Примеры объектов:**
- "ЖК Солнечный, корпус 3" (внутри проекта "ЖК Солнечный")
- "Парковка подземная" (внутри проекта "Торговый центр")
- "Спортзал" (внутри проекта "Реконструкция школы")

### Структура данных объекта:
```
objects:
  - id (уникальный идентификатор)
  - title (название объекта)
  - address (адрес)
  - description (описание)
  - project_id (к какому проекту относится)
  - status (active/paused/completed)
  - created_at, updated_at
```

### Логика работы с объектами:

#### Создание объекта:
1. Заказчик переходит в проект
2. Нажимает "Создать объект"
3. Заполняет:
   - Название (обязательно)
   - Адрес (обязательно)
   - Описание (опционально)
4. Объект создаётся в статусе "active"

#### Просмотр объектов:
- **Заказчик** видит все объекты своих проектов
- **Подрядчик** видит только объекты, где у него есть назначенные работы
- **Админ** видит все объекты

#### Статусы объекта:
- `active` — объект активен, работы ведутся
- `paused` — объект временно приостановлен
- `completed` — объект завершён

#### Редактирование объекта:
- Может Заказчик (владелец проекта)
- Может Админ
- Подрядчик НЕ может редактировать

---

## СПРАВОЧНИК РАБОТ (Work Templates)

### Что это?
Справочник работ — это библиотека типовых строительных работ с их характеристиками. Это шаблоны, из которых потом создаются конкретные работы на объектах.

**Примеры записей справочника:**
- "Возведение кирпичных стен" (код: КС-01, категория: Каменные работы)
- "Монтаж электропроводки скрытой" (код: ЭМ-03, категория: Электромонтажные работы)
- "Укладка керамической плитки" (код: ОТ-12, категория: Отделочные работы)

### Структура данных:
```
work_templates:
  - id (уникальный идентификатор)
  - code (код работы, например "КС-01")
  - title (название работы)
  - description (подробное описание)
  - category (категория: "Каменные работы", "Отделочные работы" и т.д.)
  - normative_ref (ссылка на нормативы: СНиП, ГОСТ и т.д.)
  - material_types (типы используемых материалов)
  - control_points (точки контроля качества в формате JSON)
  - created_at
```

### Категории работ:
- Общестроительные работы
- Земляные работы
- Каменные работы
- Бетонные работы
- Монтаж конструкций
- Кровельные работы
- Отделочные работы
- Электромонтажные работы
- Сантехнические работы
- Вентиляция и кондиционирование

### Точки контроля (control_points):
Это массив JSON с описанием критических проверок для работы.

**Пример:**
```json
[
  {
    "stage": "Подготовка",
    "checks": ["Проверка основания", "Разметка осей"]
  },
  {
    "stage": "Основные работы",
    "checks": ["Контроль толщины слоя", "Проверка вертикальности"]
  },
  {
    "stage": "Приёмка",
    "checks": ["Визуальный осмотр", "Замеры отклонений"]
  }
]
```

### Логика использования справочника:

#### 1. Просмотр справочника:
- Доступен всем авторизованным пользователям
- GET запрос возвращает список всех шаблонов
- Шаблоны отсортированы по категориям и названиям

#### 2. Добавление новой записи:
- Может выполнить Заказчик или Админ
- Обязательные поля: `title`, `code`
- Остальные поля опциональны

**Сценарий:**
1. Админ/Заказчик открывает справочник
2. Нажимает "Добавить тип работы"
3. Заполняет форму:
   - Код работы (уникальный)
   - Название
   - Категория (выбирается из списка)
   - Описание
   - Нормативные документы
   - Типы материалов
   - Точки контроля
4. Сохраняет — запись появляется в справочнике

#### 3. Использование при создании работы:
Когда Заказчик создаёт работу на объекте, он может:
- Выбрать шаблон из справочника
- Система автоматически подставит описание, материалы, точки контроля
- Заказчик может отредактировать данные для конкретной работы

**Связь:**
```
work_templates (шаблон)
       ↓ template_id
works (конкретная работа на объекте)
```

#### 4. Редактирование/удаление:
- Может выполнить только Админ
- При удалении шаблона существующие работы НЕ удаляются (связь опциональная)

---

## РАБОТЫ НА ОБЪЕКТАХ

### Что такое работа?
Работа — это конкретная задача для подрядчика на объекте.

**Примеры работ:**
- "Возведение стен 3 этажа, секция А" (на объекте "Корпус 3")
- "Монтаж электрики в квартирах 301-310" (на объекте "Корпус 3")
- "Укладка плитки в холле 1 этажа" (на объекте "Корпус 3")

### Структура данных работы:
```
works:
  - id (уникальный идентификатор)
  - title (название работы)
  - description (описание)
  - object_id (к какому объекту относится)
  - contractor_id (ID подрядчика-исполнителя, может быть NULL)
  - contractor_organization_id (ID организации подрядчика, если есть)
  - template_id (ID шаблона из справочника, опционально)
  - status (статус работы: pending/in_progress/on_review/completed/rejected)
  - work_status (дублирующий статус для совместимости)
  - start_date, end_date (фактические даты)
  - planned_start_date, planned_end_date (плановые даты)
  - completion_percentage (процент выполнения 0-100)
  - photos (массив JSON с фотографиями)
  - materials (массив JSON с использованными материалами)
  - created_at, updated_at
```

### Логика создания работы:

#### Сценарий 1: Создание с нуля
1. Заказчик открывает объект
2. Нажимает "Добавить работу"
3. Заполняет вручную:
   - Название работы (обязательно)
   - Описание
   - Выбирает подрядчика из списка своих подрядчиков
   - Указывает плановые даты начала и окончания
4. Работа создаётся в статусе `pending` (запланирована)

#### Сценарий 2: Создание из шаблона
1. Заказчик открывает объект
2. Нажимает "Добавить работу из справочника"
3. Выбирает шаблон работы (например, "Возведение кирпичных стен")
4. Система автоматически заполняет:
   - Название (из шаблона)
   - Описание (из шаблона)
   - Материалы (из шаблона)
   - Точки контроля (из шаблона)
   - Записывает `template_id` для связи
5. Заказчик дополнительно указывает:
   - Конкретизирует название (например, добавляет "3 этаж, секция А")
   - Выбирает подрядчика
   - Указывает плановые даты
6. Работа создаётся в статусе `pending`

### Назначение/переназначение подрядчика:
- При создании работы подрядчик может быть НЕ назначен (contractor_id = NULL)
- Заказчик может позже назначить подрядчика через действие "Назначить исполнителя"
- Заказчик может переназначить работу на другого подрядчика
- При переназначении статус работы сбрасывается на `pending`

---

## ЖИЗНЕННЫЙ ЦИКЛ РАБОТ

### Статусы работы:
1. **pending** (Запланирована) — работа создана, но ещё не начата
2. **in_progress** (В работе) — подрядчик начал выполнение
3. **on_review** (На проверке) — подрядчик завершил, ждёт приёмки заказчиком
4. **completed** (Выполнена) — работа принята заказчиком
5. **rejected** (Отклонена) — работа не принята, нужны доработки

### Переходы между статусами:

```
pending → in_progress → on_review → completed
                            ↓
                        rejected → in_progress
```

### Кто может менять статусы:

| Переход | Кто выполняет | Логика |
|---------|---------------|--------|
| `pending` → `in_progress` | Подрядчик | Подрядчик начинает работу. Фиксируется фактическая дата начала (`start_date = today`) |
| `in_progress` → `on_review` | Подрядчик | Подрядчик завершает работу и отправляет на проверку. Фиксируется фактическая дата окончания (`end_date = today`) |
| `on_review` → `completed` | Заказчик или Админ | Заказчик принимает работу. Работа закрывается. |
| `on_review` → `rejected` | Заказчик или Админ | Заказчик отклоняет работу с указанием причины. Подрядчик должен доработать. |
| `rejected` → `in_progress` | Подрядчик | Подрядчик берёт работу на доработку. |

### Детальная логика переходов:

#### 1. Подрядчик начинает работу (pending → in_progress):
**Условия:**
- Работа в статусе `pending`
- Текущий пользователь — назначенный подрядчик

**Действия:**
1. Подрядчик открывает работу
2. Нажимает кнопку "Начать работу"
3. Система меняет статус на `in_progress`
4. Система записывает `start_date = CURRENT_DATE`
5. Подрядчик видит уведомление "Работа начата"

#### 2. Подрядчик завершает работу (in_progress → on_review):
**Условия:**
- Работа в статусе `in_progress`
- Текущий пользователь — назначенный подрядчик

**Действия:**
1. Подрядчик добавляет фото выполненной работы (опционально)
2. Добавляет использованные материалы (опционально)
3. Указывает процент выполнения (по умолчанию 100%)
4. Нажимает кнопку "Отправить на проверку"
5. Система меняет статус на `on_review`
6. Система записывает `end_date = CURRENT_DATE`
7. Заказчик получает уведомление "Работа готова к проверке"

#### 3. Заказчик принимает работу (on_review → completed):
**Условия:**
- Работа в статусе `on_review`
- Текущий пользователь — заказчик (владелец проекта) или админ

**Действия:**
1. Заказчик открывает работу
2. Просматривает фото, материалы, описание
3. Нажимает кнопку "Принять работу"
4. Система меняет статус на `completed`
5. Подрядчик получает уведомление "Работа принята"
6. Работа больше не может быть изменена

#### 4. Заказчик отклоняет работу (on_review → rejected):
**Условия:**
- Работа в статусе `on_review`
- Текущий пользователь — заказчик или админ

**Действия:**
1. Заказчик открывает работу
2. Нажимает кнопку "Отклонить работу"
3. В модальном окне указывает причину отклонения (обязательно)
4. Система меняет статус на `rejected`
5. Система сохраняет причину в `description` или специальное поле комментариев
6. Подрядчик получает уведомление "Работа отклонена" с причиной
7. Работа возвращается подрядчику на доработку

#### 5. Подрядчик доработает отклонённую работу (rejected → in_progress):
**Условия:**
- Работа в статусе `rejected`
- Текущий пользователь — назначенный подрядчик

**Действия:**
1. Подрядчик открывает работу
2. Читает причину отклонения
3. Нажимает кнопку "Взять в работу"
4. Система меняет статус на `in_progress`
5. Подрядчик исправляет недостатки
6. Снова отправляет на проверку (см. пункт 2)

### Ограничения и правила:

#### Изменение данных работы:
- **Заказчик** может редактировать работу в любом статусе (название, описание, плановые даты, переназначать подрядчика)
- **Подрядчик** может добавлять фото и материалы только в статусах `in_progress` и `rejected`
- **Подрядчик** НЕ может редактировать название, описание, плановые даты
- В статусе `completed` никто не может изменять работу (только просмотр)

#### Удаление работы:
- Может удалить только Заказчик или Админ
- Работу в статусе `completed` удалить нельзя (только архивировать)

#### Процент выполнения:
- Подрядчик может обновлять `completion_percentage` в процессе работы
- По умолчанию: `pending` = 0%, `in_progress` = зависит от ввода подрядчика, `on_review/completed` = 100%

---

## ПРАВА ДОСТУПА

### Матрица прав доступа:

| Действие | Заказчик (client) | Подрядчик (contractor) | Админ (admin) |
|----------|-------------------|------------------------|---------------|
| **ПРОЕКТЫ** |
| Создать проект | ✅ | ❌ | ✅ |
| Просмотреть свои проекты | ✅ (только свои) | ❌ | ✅ (все) |
| Редактировать проект | ✅ (только свои) | ❌ | ✅ |
| Удалить проект | ✅ (только свои) | ❌ | ✅ |
| **ОБЪЕКТЫ** |
| Создать объект | ✅ (в своих проектах) | ❌ | ✅ |
| Просмотреть объекты | ✅ (своих проектов) | ✅ (где есть работы) | ✅ (все) |
| Редактировать объект | ✅ (своих проектов) | ❌ | ✅ |
| Удалить объект | ✅ (своих проектов) | ❌ | ✅ |
| **РАБОТЫ** |
| Создать работу | ✅ (на своих объектах) | ❌ | ✅ |
| Просмотреть работы | ✅ (на своих объектах) | ✅ (только свои) | ✅ (все) |
| Редактировать работу | ✅ (на своих объектах) | ⚠️ (только фото/материалы) | ✅ |
| Назначить подрядчика | ✅ | ❌ | ✅ |
| Начать работу | ❌ | ✅ (свои работы) | ✅ |
| Отправить на проверку | ❌ | ✅ (свои работы) | ✅ |
| Принять/отклонить работу | ✅ | ❌ | ✅ |
| Удалить работу | ✅ | ❌ | ✅ |
| **СПРАВОЧНИК РАБОТ** |
| Просмотреть справочник | ✅ | ✅ | ✅ |
| Добавить шаблон | ✅ | ❌ | ✅ |
| Редактировать шаблон | ❌ | ❌ | ✅ |
| Удалить шаблон | ❌ | ❌ | ✅ |

---

## СВЯЗИ МЕЖДУ СУЩНОСТЯМИ

### Схема связей:

```
users (пользователи)
  ├── role: 'client' / 'contractor' / 'admin'
  └── onboarding_completed (для клиентов)

projects (проекты)
  ├── client_id → users.id (владелец проекта)
  └── Содержит несколько objects

objects (объекты)
  ├── project_id → projects.id (к какому проекту относится)
  └── Содержит несколько works

works (работы)
  ├── object_id → objects.id (на каком объекте)
  ├── contractor_id → users.id (кто исполняет)
  ├── contractor_organization_id → organizations.id (организация подрядчика, опционально)
  └── template_id → work_templates.id (из какого шаблона создана, опционально)

work_templates (справочник работ)
  └── Используется для создания works
```

### Правило каскадного доступа:

**Для Заказчика:**
1. Пользователь видит проекты, где `projects.client_id = user_id`
2. Пользователь видит объекты, где `objects.project_id IN (мои проекты)`
3. Пользователь видит работы, где `works.object_id IN (мои объекты)`

**Для Подрядчика:**
1. Пользователь видит работы, где `works.contractor_id = user_id`
2. Пользователь видит объекты, где `objects.id IN (объекты с моими работами)`
3. Пользователь НЕ видит проекты напрямую (только через объекты)

**Для Админа:**
- Видит всё без ограничений

---

## ДОПОЛНИТЕЛЬНЫЕ ФИЧИ

### 1. Фотографии работ:
- Хранятся в поле `photos` (JSONB)
- Структура: `[{"url": "https://...", "uploaded_at": "2025-01-01T12:00:00Z", "description": "Фото после укладки"}]`
- Добавляются подрядчиком в процессе работы

### 2. Материалы:
- Хранятся в поле `materials` (JSONB)
- Структура: `[{"name": "Кирпич керамический", "quantity": 1000, "unit": "шт", "cost": 50000}]`
- Добавляются подрядчиком для отчётности

### 3. Уведомления:
Система отправляет уведомления при:
- Назначении работы подрядчику
- Отправке работы на проверку
- Принятии работы
- Отклонении работы
- Приближении дедлайна (`planned_end_date`)

### 4. Аналитика:
Система может показывать:
- Количество работ по статусам на объекте
- Процент выполнения объекта (среднее от всех работ)
- Просроченные работы (где `end_date > planned_end_date`)
- Загрузка подрядчиков (сколько работ в процессе)

---

## ИТОГОВАЯ СХЕМА РАБОТЫ СИСТЕМЫ

### Типичный сценарий использования:

1. **Заказчик регистрируется** → role = 'client'
2. **Заказчик создаёт проект** → "ЖК Солнечный"
3. **Заказчик создаёт объекты** → "Корпус 1", "Корпус 2", "Парковка"
4. **Заказчик добавляет подрядчиков** → выбирает из списка зарегистрированных пользователей с role = 'contractor'
5. **Заказчик создаёт работы на объектах:**
   - Вариант А: Создаёт вручную, заполняет все поля
   - Вариант Б: Выбирает из справочника `work_templates`, система подставляет данные
6. **Заказчик назначает работы подрядчикам** → работа в статусе `pending`
7. **Подрядчик получает уведомление** → видит новую работу в своём списке
8. **Подрядчик начинает работу** → статус меняется на `in_progress`
9. **Подрядчик в процессе работы:**
   - Добавляет фото
   - Добавляет использованные материалы
   - Обновляет процент выполнения
10. **Подрядчик завершает работу** → отправляет на проверку, статус `on_review`
11. **Заказчик проверяет работу:**
    - Если всё OK → принимает, статус `completed`
    - Если есть замечания → отклоняет с причиной, статус `rejected`
12. **Если работа отклонена** → подрядчик берёт в работу снова, исправляет, отправляет повторно

---

## ТЕХНИЧЕСКИЕ ДЕТАЛИ РЕАЛИЗАЦИИ

### Backend API:

**Объекты (`/backend/objects`):**
- `GET ?project_id=X` — список объектов проекта
- `GET ?id=X` — детали объекта
- `GET ?contractor_id=X` — объекты подрядчика (где у него есть работы)
- `POST` — создать объект (body: project_id, title, address, description)
- `PUT ?id=X` — обновить объект
- `DELETE ?id=X` — удалить объект

**Работы (`/backend/works`):**
- `GET ?object_id=X` — список работ объекта
- `GET ?id=X` — детали работы
- `POST` — создать работу (body: object_id, title, description, contractor_id, template_id, planned_start_date, planned_end_date)
- `PUT ?id=X` — обновить работу
- `DELETE ?id=X` — удалить работу

**Справочник работ (`/backend/work-types`):**
- `GET` — список всех шаблонов
- `POST` — создать шаблон (body: code, title, category, description, normative_ref, material_types, control_points)
- `PUT ?id=X` — обновить шаблон
- `DELETE ?id=X` — удалить шаблон

### Database Schema:

```sql
-- Проекты
projects:
  id SERIAL PRIMARY KEY
  title VARCHAR(255) NOT NULL
  description TEXT
  client_id INT NOT NULL REFERENCES users(id)
  status VARCHAR(20) DEFAULT 'active'
  created_at TIMESTAMP DEFAULT NOW()
  updated_at TIMESTAMP DEFAULT NOW()

-- Объекты
objects:
  id SERIAL PRIMARY KEY
  title VARCHAR(255) NOT NULL
  address TEXT
  description TEXT
  project_id INT NOT NULL REFERENCES projects(id)
  status VARCHAR(20) DEFAULT 'active'
  created_at TIMESTAMP DEFAULT NOW()
  updated_at TIMESTAMP DEFAULT NOW()

-- Работы
works:
  id SERIAL PRIMARY KEY
  title VARCHAR(255) NOT NULL
  description TEXT
  object_id INT NOT NULL REFERENCES objects(id)
  contractor_id INT REFERENCES users(id)
  contractor_organization_id INT REFERENCES organizations(id)
  template_id INT REFERENCES work_templates(id)
  status VARCHAR(20) DEFAULT 'pending'
  work_status VARCHAR(20) DEFAULT 'planned'
  start_date DATE
  end_date DATE
  planned_start_date DATE
  planned_end_date DATE
  completion_percentage INT DEFAULT 0
  photos JSONB DEFAULT '[]'
  materials JSONB DEFAULT '[]'
  created_at TIMESTAMP DEFAULT NOW()
  updated_at TIMESTAMP DEFAULT NOW()

-- Справочник работ
work_templates:
  id SERIAL PRIMARY KEY
  code VARCHAR(50) NOT NULL UNIQUE
  title TEXT NOT NULL
  description TEXT
  category VARCHAR(255)
  normative_ref VARCHAR(255)
  material_types TEXT
  control_points JSONB
  created_at TIMESTAMP DEFAULT NOW()
```

---

## ЗАКЛЮЧЕНИЕ

Это полное описание логики системы Реестра Объектов и Работ. По этому документу можно:
- Воссоздать функционал с нуля
- Понять бизнес-процессы
- Написать документацию для пользователей
- Обучить новых разработчиков

Если нужны уточнения по каким-то сценариям — дополню документ!
